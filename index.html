<!DOCTYPE html>
<html>

<head>
    <title>Terminal web Maude</title>
    <meta charset="UTF-8">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="/js/jquery.terminal.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(function() {
            const PROMPT = 'Maude>';
            const MAUDE = 'Maude> ';
            const LOAD = 'load';
            const QUIT = 'quit';
            const COMANDO_NO_VALIDO = 'Comando no valido: ';

            $("#fileupload").click(function() {
                $("#files").click();
            });

            var socket = io.connect('http://localhost:9090');
            var terminal = $('#terminal').terminal(function(command, terminal) {
                introducir_comando(command);

            }, {
                greetings: '',
                prompt: PROMPT,
                exit: false
            });
            socket.on('stdout', function(data) {
                var salida = String(data);

                if (salida.endsWith(MAUDE)) {
                    salida = salida.substr(0, salida.length - MAUDE.length);
                }

                terminal.echo(salida);
            });
            socket.on('stderr', function(data) {
                terminal.error(String(data));
            });
            socket.on('disconnect', function() {
                alert('Conexion perdida');
                terminal.disable();
            });
            socket.on('enable', function() {
                terminal.enable();
            });
            socket.on('disable', function() {
                terminal.disable();
            });

            //COMIENZA LA SUBIDA DE ARCHIVOS
            if (window.File && window.FileList && window.FileReader) {
                var filesInput = document.getElementById("files");

                filesInput.addEventListener("change", function(event) {

                    var files = event.target.files; //FileList object

                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];

                        var picReader = new FileReader();

                        picReader.addEventListener("load", function(event) {

                            var abc = event.target.result.split('\n');

                            for (var j = 0; j < abc.length; j++) {
                                introducir_comando(abc[j]);
                            }
                        });

                        //Read the text file
                        picReader.readAsText(file);
                    }

                });
            } else {
                alert("Your browser does not support File API");
            }


            function introducir_comando(command) {
                var cmd = command.substr(0, LOAD.length);

                if (cmd == LOAD || cmd == QUIT) {
                    terminal.error(COMANDO_NO_VALIDO + command);
                } else {
                    socket.emit('stdin', command);
                }
            }
        });
    </script>
    <link type="text/css" href="/css/jquery.terminal.css" rel="stylesheet" />
    <link type="text/css" href="/css/estilo.css" rel="stylesheet" />
</head>

<body>
    <div id="menu">
        <a class="boton" href="https://es.wikipedia.org/wiki/Maude_(lenguaje_de_programaci%C3%B3n)">¿Que es?</a>
        <a class="boton" href="http://maude.cs.illinois.edu/w/index.php?title=The_Maude_System">Página oficial</a>
        <a class="boton" href="http://maude.cs.illinois.edu/w/images/e/e0/Maude-2.7.1-manual.pdf">Manual</a>
        <input id="files" type="file" accept=".nat" multiple=false/>
        <a class="boton" id="fileupload" href="javascript:void(0)">Subir naturaleza</a>
    </div>
    <div id="terminal"></div>

    <a id="fork" href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
            alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
</body>

</html>